name: Rollback Backend

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'VersiÃ³n o tag de imagen a restaurar (ej: v1.0.123 o sha-abc1234)'
        required: true
        type: string
      reason:
        description: 'RazÃ³n del rollback'
        required: true
        type: string
      emergency:
        description: 'Rollback de emergencia (auto-merge sin PR para ArgoCD)'
        required: false
        type: boolean
        default: false

env:
  DOCKERHUB_ORG: retrogamehub
  K8S_REPO: retrogamecloud/kubernetes
  K8S_MANIFEST_FILE: 02-backend.yaml

jobs:
  rollback:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Validar que la imagen existe en Docker Hub
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SERVICE="${{ github.event.repository.name }}"
          
          # Verificar si la imagen existe
          if docker manifest inspect ${{ env.DOCKERHUB_ORG }}/${SERVICE}:${VERSION} > /dev/null 2>&1; then
            echo "âœ… Imagen ${{ env.DOCKERHUB_ORG }}/${SERVICE}:${VERSION} encontrada"
          else
            echo "âŒ Error: La imagen ${{ env.DOCKERHUB_ORG }}/${SERVICE}:${VERSION} no existe"
            exit 1
          fi

      - name: Clonar repositorio de Kubernetes
        uses: actions/checkout@v6
        with:
          repository: ${{ env.K8S_REPO }}
          token: ${{ secrets.K8S_UPDATE_TOKEN }}
          ref: main

      - name: Rollback a versiÃ³n anterior
        run: |
          VERSION="${{ github.event.inputs.version }}"
          REASON="${{ github.event.inputs.reason }}"
          SERVICE="${{ github.event.repository.name }}"
          
          # Actualizar manifiesto
          sed -i "s|image: ${{ env.DOCKERHUB_ORG }}/${SERVICE}:.*|image: ${{ env.DOCKERHUB_ORG }}/${SERVICE}:${VERSION}|g" ${{ env.K8S_MANIFEST_FILE }}
          sed -i "s|# Imagen del ${SERVICE} desde DockerHub.*|# Imagen del ${SERVICE} desde DockerHub - ROLLBACK a ${VERSION}|g" ${{ env.K8S_MANIFEST_FILE }}

      - name: Configurar Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Aplicar cambios (PR o directo segÃºn modo de emergencia)
        run: |
          VERSION="${{ github.event.inputs.version }}"
          REASON="${{ github.event.inputs.reason }}"
          SERVICE="${{ github.event.repository.name }}"
          EMERGENCY="${{ github.event.inputs.emergency }}"
          
          git add ${{ env.K8S_MANIFEST_FILE }}
          
          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "âš ï¸ No hay cambios en el manifiesto"
            exit 0
          fi
          
          # Asegurar que las etiquetas existan en el repositorio destino
          echo "Verificando/creando labels requeridos..."
          for lbl in rollback urgent; do
            if ! gh label list --repo ${{ env.K8S_REPO }} | grep -E "^${lbl}\b" > /dev/null; then
              echo "Creando label: ${lbl}"
              # Colores por defecto: rollback (rojo), urgent (naranja)
              case "$lbl" in
                rollback)
                  gh label create rollback --color FF0000 --description "Cambios de rollback" --repo ${{ env.K8S_REPO }} || true
                  ;;
                urgent)
                  gh label create urgent --color F29513 --description "AcciÃ³n prioritaria" --repo ${{ env.K8S_REPO }} || true
                  ;;
              esac
            fi
          done

          if [ "$EMERGENCY" = "true" ]; then
            # MODO EMERGENCIA: Commit directo a main (ArgoCD lo sincroniza inmediatamente)
            echo "ðŸš¨ MODO EMERGENCIA: Aplicando rollback directo a main"
            
            git commit -m "ðŸš¨ ROLLBACK EMERGENCIA: Restaurar ${SERVICE} a ${VERSION}" \
                       -m "RazÃ³n: ${REASON}" \
                       -m "Ejecutado por: ${{ github.actor }}" \
                       -m "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
                       -m "[skip ci]"
            
            git push origin main
            
            echo "âœ… Rollback aplicado directamente. ArgoCD sincronizarÃ¡ automÃ¡ticamente."
          else
            # MODO NORMAL: Crear PR para revisiÃ³n
            BRANCH_NAME="rollback/${SERVICE}-${VERSION}-$(date +%s)"
            
            git checkout -b "${BRANCH_NAME}"
            
            git commit -m "ðŸ”™ ROLLBACK: Restaurar ${SERVICE} a ${VERSION}" \
                       -m "RazÃ³n: ${REASON}" \
                       -m "Ejecutado por: ${{ github.actor }}" \
                       -m "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            git push origin "${BRANCH_NAME}"
            
            gh pr create \
              --repo ${{ env.K8S_REPO }} \
              --base main \
              --head "${BRANCH_NAME}" \
              --title "ðŸ”™ ROLLBACK: ${SERVICE} a ${VERSION}" \
              --body "Rollback de ${SERVICE} - Version: ${VERSION}, Razon: ${REASON}, Ejecutado por: ${{ github.actor }}" \
              --label rollback --label urgent
            
            echo "âœ… PR de rollback creado. Aprobar para que ArgoCD sincronice."
          fi
        env:
          GH_TOKEN: ${{ secrets.K8S_UPDATE_TOKEN }}

      - name: Notificar resultado
        run: |
          EMERGENCY="${{ github.event.inputs.emergency }}"
          
          if [ "$EMERGENCY" = "true" ]; then
            echo "## ðŸš¨ Rollback de Emergencia Aplicado" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **VersiÃ³n restaurada**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **RazÃ³n**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Ejecutado por**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Modo**: EMERGENCIA (commit directo a main)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **ArgoCD sincronizarÃ¡ automÃ¡ticamente en ~30 segundos**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Rollback Iniciado" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **VersiÃ³n restaurada**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **RazÃ³n**: ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Ejecutado por**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Modo**: Normal (requiere aprobaciÃ³n)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **AcciÃ³n requerida**: Aprobar el PR â†’ ArgoCD sincronizarÃ¡ automÃ¡ticamente" >> $GITHUB_STEP_SUMMARY
          fi
